name: e2e_test

on:
  pull_request:
    branches:
      - OSC-MIGRATION
      - main
    paths:
      - "**.go"
      - "Dockerfile"
      - "Makefile"
      - "go.*"
      - "helm/osc-bsu-csi-driver/**.yaml"
      - ".github/workflows/e2e_test.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sanity:
    runs-on: [self-hosted, linux]
    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
    - name: üîê Set ak/sk name based on runner region
      run: .github/scripts/runneraksk.sh
    - name: ‚¨áÔ∏è Install Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'
    - name: üßπ Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        secret_key: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        region: ${{ env.OSC_REGION }}
    - name: üß™ Sanity test
      run:
        make test-sanity
      env:
        OSC_ACCESS_KEY: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        OSC_SECRET_KEY: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        OSC_REGION: ${{ env.OSC_REGION }}
  e2e:
    runs-on: [self-hosted, linux]
    needs: [sanity]
    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
    - name: üîê Set ak/sk name based on runner region
      run: .github/scripts/runneraksk.sh
    - name: ‚¨áÔ∏è Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4
      with:
        version: v1.34.2
    - name: ‚¨áÔ∏è Install helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
      with:
        version: v3.19.2
    - name: ‚¨áÔ∏è Install Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
      with:
        go-version-file: 'go.mod'
    - name: üßπ Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        secret_key: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        region: ${{ env.OSC_REGION }}
    - name: üë∑ Deploy test cluster
      id: caposc
      uses: outscale/cluster-api-provider-outscale/github_actions/deploy_cluster@main
      with:
        RUNNER_NAME: ${{ runner.name }}
        OKS_ACCESS_KEY: ${{ secrets.OKS_ACCESS_KEY }}
        OKS_SECRET_KEY: ${{ secrets.OKS_SECRET_KEY }}
        OKS_REGION: ${{ vars.OKS_REGION }}
        OSC_ACCESS_KEY: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        OSC_SECRET_KEY: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        OSC_REGION: ${{ env.OSC_REGION }}
        CLUSTER_NAME: "csi"
        IMAGE_NAME: ${{ vars.IMG_MANAGEMENT }}
        CCM: true
        KUSTOMIZE_PATH: "tests/e2e/capi-kustomize"
    - name: üì¶ Build & Push the Docker image
      run: |
        docker login ${{ vars.REGISTRY }} -u admin -p ${{ secrets.HARBOR_ADMIN_PASSWORD }}
        make buildx-image image-tag image-push
      env:
        REGISTRY_IMAGE: "${{ vars.REGISTRY }}/outscale/csi"
        IMAGE_TAG: ${{ github.sha }}
        REGISTRY_TAG: ${{ github.sha }}
    - name: üë∑ Install CSI
      run: |
        kubectl create secret generic osc-csi-bsu --from-literal=access_key=$OSC_ACCESS_KEY --from-literal=secret_key=$OSC_SECRET_KEY -n kube-system
        kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.3/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.3/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.3/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.3/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.3/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
        make helm_deploy 
      env:
        KUBECONFIG: "${{ github.workspace }}/${{ steps.caposc.outputs.KUBECONFIG }}"
        OSC_ACCESS_KEY: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        OSC_SECRET_KEY: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        OSC_REGION: ${{ env.OSC_REGION}}
        TARGET_IMAGE: "${{ vars.REGISTRY }}/outscale/csi"
        TARGET_TAG: ${{ github.sha }}
    - name: üß™ Run e2e tests
      run: make test-e2e
      env:
        KUBECONFIG: "${{ github.workspace }}/${{ steps.caposc.outputs.KUBECONFIG }}"
        OSC_ACCESS_KEY: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        OSC_SECRET_KEY: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        OSC_REGION: ${{ env.OSC_REGION }}
        AWS_AVAILABILITY_ZONES: ${{ env.OSC_SUBREGION_NAME }}