apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../base
- ../../snapshotter
namespace: kube-system

images:
- name: outscale/osc-ebs-csi-driver
  newTag: v0.0.14beta
  newName: outscale/osc-ebs-csi-driver
- name: k8s.gcr.io/sig-storage/csi-provisioner
  newTag: v3.0.0
  newName: k8s.gcr.io/sig-storage/csi-provisioner
- name: k8s.gcr.io/sig-storage/csi-attacher
  newTag: v3.3.0
  newName: k8s.gcr.io/sig-storage/csi-attacher
- name: k8s.gcr.io/sig-storage/csi-snapshotter
  newTag: v4.2.1
  newName: k8s.gcr.io/sig-storage/csi-snapshotter
- name: k8s.gcr.io/sig-storage/livenessprobe
  newTag: v2.5.0
  newName: k8s.gcr.io/sig-storage/livenessprobe
- name: k8s.gcr.io/sig-storage/csi-resizer
  newTag: v1.3.0
  newName: k8s.gcr.io/sig-storage/csi-resizer
- name: k8s.gcr.io/sig-storage/csi-node-driver-registrar
  newTag: v2.3.0
  newName: k8s.gcr.io/sig-storage/csi-node-driver-registrar
- name: k8s.gcr.io/sig-storage/snapshot-controller
  newTag: v3.0.3
  newName: k8s.gcr.io/sig-storage/snapshot-controller
# replicas (default 2)
replicas:
- name: ebs-csi-controller
  count: 3

patches:
   - target:
       kind: DaemonSet
# imagePullSecrets (dockerconfig secret)
     patch: |-
       - op: replace
         path: /spec/template/spec/imagePullSecrets
         value: [{ name: registry-dockerconfigjson }]
   - target:
       kind: Deployment
# imagePullSecrets (dockerconfig secret)
     patch: |-
       - op: replace
         path: /spec/template/spec/imagePullSecrets
         value: [{ name: registry-dockerconfigjson }]
# Option to apply permission modifications
   - target:
       kind: CSIDriver
     patch: |-
       - op: replace
         path: /spec/fsGroupPolicy
         value: File
# If enable volume scheduling for dynamic volume provisioning
   - patch: |-
      - op: add
        path: /spec/template/spec/containers/1/args/-
        value: --feature-gates=Topology=true
     target:
       kind: Deployment
# If set, add pv/pvc metadata to plugin create requests as parameters.
   - patch: |-
      - op: add
        path: /spec/template/spec/containers/1/args/-
        value: --extra-create-metadata
     target:
       kind: Deployment

patchesJson6902:
# Add serviceAccount controller annotations
- target:
    version: v1
    kind: ServiceAccount
    name: ebs-csi-controller-sa
  patch: |-
    - op: add
      path: /metadata/annotations/kubernetes.io~1ingress.global-static-ip-name
      value: my-static-ip-name   
# Add Daemonset podAnnotations and podLabels
- target:
    version: v1
    kind: DaemonSet
    name: ebs-csi-node
  patch: |-
    - op: add
      path: /spec/template/metadata/annotations
      value: {"name": "ebs-csi-node"}
    - op: add
      path: /spec/template/metadata/labels/kubernetes.io~1name
      value: ebs-csi-node
# Add Deployment podAnnotations and podLabels
- target:
    version: v1
    kind: Deployment
    name: ebs-csi-controller
  patch: |-
    - op: add
      path: /spec/template/metadata/annotations
      value: {"name": "ebs-csi-controller"}
    - op: add
      path: /spec/template/metadata/labels/kubernetes.io~1name
      value: ebs-csi-controller


patchesStrategicMerge:
# set the verbosity level of plugins and timeout for sidecars
- verbosity_timeout.yaml
# Add ebs-plugin env
- backoff.yaml
# enable volume snapshot
- csi_resizer.yaml
- csi_snapshotter.yaml
# Add resources limit and request
- resource.yaml
